import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from statsmodels.tsa.holtwinters import ExponentialSmoothing

# Given the stock information of at least the past 5 days of all companies, try to predict the closing price of one company on a particular day
# Load the dataset
data = pd.read_csv(r"C:\Users\Admin\IT1244-Stock-Market\merged_company_data.csv")

# Convert 'Date' to datetime
data['Date'] = pd.to_datetime(data['Date'])

# Define the company of interest
target_company = 'CRL'  # Replace with your target company name

# Ensure we have data for the target company
if target_company not in data['Symbol'].unique():
    raise ValueError(f"{target_company} is not in the dataset.")

# Filter data for the target company
target_data = data[data['Symbol'] == target_company].set_index('Date')

# Ensure we have enough data for the target company
if len(target_data) < 5:
    raise ValueError("Not enough data to predict. At least 5 days are required.")

# Get the last n days of data for the target company
last_n_days_target = target_data['Close'].tail(120)

# Get the last n days of data for all companies
last_n_days_all = data[data['Date'].isin(last_n_days_target.index)]
avg_last_n_days = last_n_days_all.groupby('Date')['Close'].mean()

# Fit the Holt-Winters model
model = ExponentialSmoothing(
    avg_last_n_days,
    trend='add',
    seasonal=None  # Assuming no seasonality for short-term prediction
).fit()

# Forecast the next day's closing price
forecast = model.forecast(steps=1)

# Prepare data for visualization
smoothed_values = model.fittedvalues

# Visualization
plt.figure(figsize=(10, 5))
plt.plot(last_n_days_target.index, last_n_days_target, label=f'Historical Closing Prices of {target_company}', color='blue')
plt.plot(smoothed_values.index, smoothed_values, label='Holt-Winters Smoothed Values of All Companies', color='orange', linestyle='--')
plt.axvline(x=last_n_days_target.index[-1], color='red', linewidth=1, linestyle='--', label='Forecast Start')
plt.plot(last_n_days_target.index[-1] + pd.DateOffset(days=1), forecast, marker='o', label=f'Predicted Closing Price of {target_company}', color='green')
plt.title(f'Closing Price Prediction for {target_company}')
plt.xlabel('Date')
plt.ylabel('Closing Price')
plt.legend()
plt.xticks(rotation=45)
plt.tight_layout()
plt.show()

# Output the predicted closing price
print(f'Predicted Closing Price for {target_company} on the next day: {forecast.iloc[0]}')
